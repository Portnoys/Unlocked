<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>UNLOCKED</title>

<!-- SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#0b1020; --card:#141c3a; --line:#2b3566;
  --accent:#8b5cf6; --accent2:#22d3ee;
  --text:#f8fafc; --muted:#c7d2fe; --good:#22c55e;
}
body{
  margin:0; font-family:system-ui,Arial;
  background:radial-gradient(1200px 600px at 10% -10%,#1e2a78,var(--bg));
  color:var(--text); font-size:19px;
}
header,main{max-width:1200px;margin:auto;padding:24px}
h1{margin:0;font-size:42px}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
  border:1px solid var(--line); border-radius:22px;
  padding:26px; margin-bottom:28px;
}
input,button{
  width:100%; padding:16px; margin:8px 0;
  border-radius:14px; border:1px solid var(--line);
  background:#0b1020; color:var(--text); font-size:18px;
}
button{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  border:none; font-weight:800; cursor:pointer;
}
button.small{width:auto;font-size:15px;padding:8px 14px}
table{width:100%;border-collapse:collapse}
th,td{padding:16px;border-bottom:1px solid var(--line)}
th{color:var(--muted)}
.hidden{display:none}
.badge{padding:6px 14px;border-radius:999px;border:1px solid var(--line)}
#secretLogin{
  position:fixed;bottom:6px;left:6px;
  width:10px;height:10px;border-radius:50%;
  background:rgba(255,255,255,.15);cursor:pointer;
}
</style>
</head>

<body>

<header>
  <h1>ğŸ”“ UNLOCKED</h1>
  <span class="badge">×¡×˜×˜×•×¡: <span id="status">××‘×§×¨</span></span>
</header>

<main>

<!-- LOGIN -->
<section class="card hidden" id="loginCard">
  <h2>×”×ª×—×‘×¨×•×ª ×× ×”×œ×ª</h2>
  <input id="email" placeholder="××™×™×œ">
  <input id="password" type="password" placeholder="×¡×™×¡××”">
  <button onclick="login()">×”×ª×—×‘×¨×™</button>
</section>

<!-- ROOMS -->
<section class="card">
  <h2>×—×“×¨×™×</h2>
  <table>
    <thead>
      <tr>
        <th>×©×</th><th>×¢×™×¨</th><th>×”×¦×™×•×Ÿ ×©×œ×™</th>
        <th>×××•×¦×¢ ×§×”×™×œ×”</th><th>×“×™×¨×’×•</th><th></th>
      </tr>
    </thead>
    <tbody id="rooms"></tbody>
  </table>
</section>

<!-- ADMIN -->
<section class="card hidden" id="adminPanel">
  <h2 id="formTitle">×”×•×¡×¤×ª ×—×“×¨</h2>
  <input id="name" placeholder="×©× ×”×—×“×¨">
  <input id="city" placeholder="×¢×™×¨">
  <input id="score" type="number" min="1" max="10" step="1" placeholder="×”×¦×™×•×Ÿ ×©×œ×š">
  <button onclick="saveRoom()">×©××•×¨</button>

  <hr style="margin:24px 0;border-color:#334">

  <h2>ğŸ“¥ ×”×¢×œ××ª ×§×•×‘×¥ Excel</h2>
  <input type="file" id="excelFile" accept=".xlsx">
  <button onclick="importExcel()">×™×™×‘×•× ×—×“×¨×™×</button>
</section>

</main>

<div id="secretLogin"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getAuth, signInAnonymously,
  signInWithEmailAndPassword, onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import {
  getFirestore, collection, addDoc, updateDoc,
  deleteDoc, doc, onSnapshot, query, where, setDoc
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCuaw5E-SJM3ojbw6vhj4gw6MSjId4wosw",
  authDomain: "unlocked-67483.firebaseapp.com",
  projectId: "unlocked-67483",
  storageBucket: "unlocked-67483.firebasestorage.app",
  messagingSenderId: "565517769840",
  appId: "1:565517769840:web:aeb892e7ea92713a4e28b5"
};

const ADMIN_UID = "1Dar4ZKBqkdxTgL07krIwFodvoq2";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

let uid=null, isAdmin=false;

onAuthStateChanged(auth, user=>{
  if(user){
    uid=user.uid;
    isAdmin=uid===ADMIN_UID;
    status.textContent=isAdmin?"×× ×”×œ×ª":"××‘×§×¨";
    adminPanel.classList.toggle("hidden",!isAdmin);
    loadRooms();
  }else signInAnonymously(auth);
});

secretLogin.onclick=()=>loginCard.classList.toggle("hidden");

window.login=async()=>{
  await signInWithEmailAndPassword(auth,email.value,password.value);
  loginCard.classList.add("hidden");
};

function loadRooms(){
  onSnapshot(collection(db,"rooms"), snap=>{
    rooms.innerHTML="";
    snap.forEach(d=>{
      const r=d.data();
      const tr=document.createElement("tr");
      tr.innerHTML=`<td>${r.name}</td><td>${r.city||""}</td><td>${r.score}</td>
      <td id="avg-${d.id}">â€”</td><td id="cnt-${d.id}">0</td><td></td>`;
      rooms.appendChild(tr);
      listenRatings(d.id);
    });
  });
}

window.saveRoom=async()=>{
  if(!isAdmin) return;
  const s=parseInt(score.value,10);
  if(!name.value||Number.isNaN(s)||s<1||s>10) return alert("× ×ª×•× ×™× ×œ× ×ª×§×™× ×™×");
  await addDoc(collection(db,"rooms"),{name:name.value,city:city.value,score:s});
  name.value=city.value=score.value="";
};

/* ===== Excel Import ===== */
window.importExcel = () => {
  if(!isAdmin) return;

  const file = excelFile.files[0];
  if(!file) return alert("×œ× × ×‘×—×¨ ×§×•×‘×¥");

  const reader = new FileReader();
  reader.onload = async (e) => {
    const wb = XLSX.read(e.target.result, {type:"binary"});
    const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);
    let added = 0;

    for(const row of rows){
      const s = parseInt(row.score,10);
      if(!row.name || Number.isNaN(s) || s<1 || s>10) continue;

      await addDoc(collection(db,"rooms"),{
        name: row.name,
        city: row.city || "",
        score: s
      });
      added++;
    }
    alert(`× ×•×¡×¤×• ${added} ×—×“×¨×™×`);
    excelFile.value="";
  };
  reader.readAsBinaryString(file);
};

/* ratings */
window.rate=async(roomId)=>{
  const v=parseInt(prompt("×¦×™×•×Ÿ 1â€“10"),10);
  if(Number.isNaN(v)||v<1||v>10) return;
  await setDoc(doc(db,"ratings",`${roomId}_${uid}`),
    {roomId,uid,value:v},{merge:true});
};

function listenRatings(roomId){
  const q=query(collection(db,"ratings"),where("roomId","==",roomId));
  onSnapshot(q,s=>{
    let sum=0;
    s.forEach(d=>sum+=d.data().value);
    document.getElementById(`avg-${roomId}`).textContent=
      s.size?(sum/s.size).toFixed(1):"â€”";
    document.getElementById(`cnt-${roomId}`).textContent=s.size;
  });
}
</script>

</body>
</html>
