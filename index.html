<!doctype html>
<html lang="he" dir="rtl">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>UNLOCKED</title>

<!-- SheetJS for Excel import -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
:root{
  --bg:#0b1020; --card:#141c3a; --line:#2b3566;
  --accent:#8b5cf6; --accent2:#22d3ee;
  --text:#f8fafc; --muted:#c7d2fe; --good:#22c55e;
}
body{
  margin:0; font-family:system-ui,-apple-system,Segoe UI,Arial;
  background:radial-gradient(1200px 600px at 10% -10%,#1e2a78,var(--bg));
  color:var(--text); font-size:19px;
}
header,main{max-width:1200px;margin:auto;padding:24px}
header{display:flex;justify-content:space-between;align-items:center;padding-top:28px}
h1{margin:0;font-size:42px}
.card{
  background:linear-gradient(180deg,rgba(255,255,255,.08),rgba(255,255,255,.02));
  border:1px solid var(--line); border-radius:22px;
  padding:26px; margin-bottom:28px;
  box-shadow:0 20px 50px rgba(0,0,0,.35);
}
h2{margin:0 0 10px;font-size:28px}
input,button{
  width:100%; padding:16px; margin:8px 0;
  border-radius:14px; border:1px solid var(--line);
  background:#0b1020; color:var(--text); font-size:18px;
}
button{
  background:linear-gradient(90deg,var(--accent),var(--accent2));
  border:none; font-weight:800; cursor:pointer;
}
button.small{width:auto;font-size:15px;padding:8px 14px}
button.danger{background:#ef4444}
table{width:100%;border-collapse:collapse}
th,td{padding:16px;border-bottom:1px solid var(--line);text-align:right}
th{color:var(--muted)}
tr:hover{background:rgba(255,255,255,.04)}
.hidden{display:none}
.badge{padding:6px 14px;border-radius:999px;border:1px solid var(--line);background:#0b1020}
.ok{color:var(--good)}
.row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:720px){.row{grid-template-columns:1fr}}

#secretLogin{
  position:fixed;bottom:6px;left:6px;
  width:10px;height:10px;border-radius:50%;
  background:rgba(255,255,255,.15);cursor:pointer;z-index:9999;
}
#secretLogin:hover{background:rgba(139,92,246,.9)}
.smallnote{color:var(--muted);font-size:14px;line-height:1.6}
hr{border:0;border-top:1px solid var(--line);margin:22px 0}
</style>
</head>

<body>

<header>
  <h1>ğŸ”“ UNLOCKED</h1>
  <span class="badge">×¡×˜×˜×•×¡: <span id="status">×˜×•×¢×Ÿâ€¦</span></span>
</header>

<main>

<!-- LOGIN (opens only via secret dot) -->
<section class="card hidden" id="loginCard">
  <h2>×”×ª×—×‘×¨×•×ª ×× ×”×œ×ª</h2>
  <div class="row">
    <input id="email" placeholder="××™×™×œ">
    <input id="password" type="password" placeholder="×¡×™×¡××”">
  </div>
  <button id="loginBtn">×”×ª×—×‘×¨×™</button>
  <div class="smallnote">×˜×™×¤: ×× ×”×ª×—×‘×¨×ª ×‘×”×¦×œ×—×” ×•×¢×“×™×™×Ÿ ×›×ª×•×‘ â€œ××•×¨×—â€, ×–×” ××•××¨ ×©×”××™×™×œ ×¤×” ×œ× ×ª×•×× ×œÖ¾ADMIN_EMAIL ×‘×§×•×“.</div>
</section>

<!-- ROOMS -->
<section class="card">
  <h2>×—×“×¨×™×</h2>
  <table>
    <thead>
      <tr>
        <th>×©×</th>
        <th>×¢×™×¨</th>
        <th>×”×¦×™×•×Ÿ ×©×œ×™</th>
        <th>×××•×¦×¢ ×§×”×™×œ×”</th>
        <th>×“×™×¨×’×•</th>
        <th>×¤×¢×•×œ×•×ª</th>
      </tr>
    </thead>
    <tbody id="rooms"></tbody>
  </table>
</section>

<!-- ADMIN -->
<section class="card hidden" id="adminPanel">
  <h2 id="formTitle">×”×•×¡×¤×ª ×—×“×¨</h2>

  <div class="row">
    <input id="name" placeholder="×©× ×”×—×“×¨">
    <input id="city" placeholder="×¢×™×¨">
  </div>

  <input id="score" type="number" min="1" max="10" step="1" inputmode="numeric" placeholder="×”×¦×™×•×Ÿ ×©×œ×š (1â€“10, ×©×œ× ×‘×œ×‘×“)">
  <button id="saveBtn">×©××•×¨</button>
  <div class="smallnote">××•×ª×¨ ×¨×§ ××¡×¤×¨×™× ×©×œ××™× 1â€“10.</div>

  <hr>

  <h2>ğŸ“¥ ×”×¢×œ××ª ×§×•×‘×¥ Excel</h2>
  <div class="smallnote">×”×¢××•×“×•×ª ×—×™×™×‘×•×ª ×œ×”×™×§×¨×: <b>name</b>, <b>city</b>, <b>score</b></div>
  <input type="file" id="excelFile" accept=".xlsx">
  <button id="importBtn">×™×™×‘×•× ×—×“×¨×™×</button>
</section>

</main>

<!-- secret dot -->
<div id="secretLogin" title="admin"></div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
import {
  getAuth,
  signInAnonymously,
  signInWithEmailAndPassword,
  signOut,
  onAuthStateChanged
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
import {
  getFirestore,
  collection,
  addDoc,
  updateDoc,
  deleteDoc,
  doc,
  onSnapshot,
  query,
  where,
  setDoc
} from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyCuaw5E-SJM3ojbw6vhj4gw6MSjId4wosw",
  authDomain: "unlocked-67483.firebaseapp.com",
  projectId: "unlocked-67483",
  storageBucket: "unlocked-67483.firebasestorage.app",
  messagingSenderId: "565517769840",
  appId: "1:565517769840:web:aeb892e7ea92713a4e28b5"
};

// âœ… ×©×™××™ ×¤×” ××ª ×”××™××™×™×œ ×©×œ ×”×× ×”×œ×ª (×–×” ××” ×©×™×¤×ª×•×¨ ×œ×š ××ª â€œ×—×•×–×¨ ×œ××•×¨×—â€)
const ADMIN_EMAIL = "sigalp@gmail.com";

// ×’×™×‘×•×™ (×œ× ×—×•×‘×”, ××‘×œ × ×©××™×¨): ×”-UID ×©× ×ª×ª
const ADMIN_UID = "1Dar4ZKBqkdxTgL07krIwFodvoq2";

const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// DOM
const statusEl = document.getElementById("status");
const roomsEl = document.getElementById("rooms");
const adminPanel = document.getElementById("adminPanel");
const loginCard = document.getElementById("loginCard");
const secretLogin = document.getElementById("secretLogin");

const emailEl = document.getElementById("email");
const passEl = document.getElementById("password");
const loginBtn = document.getElementById("loginBtn");

const nameEl = document.getElementById("name");
const cityEl = document.getElementById("city");
const scoreEl = document.getElementById("score");
const saveBtn = document.getElementById("saveBtn");
const formTitle = document.getElementById("formTitle");

const excelFile = document.getElementById("excelFile");
const importBtn = document.getElementById("importBtn");

let uid = null;
let isAdmin = false;
let editingId = null;

// â­ ×ª××™×“ ××ª×—×™×œ×™× ×›××•×¨×—: ×× ×™×© session ×©×œ ×× ×”×œ×ª ×©××•×¨, ×× ×—× ×• ××ª× ×ª×§×™× ×¤×¢× ××—×ª ×‘×˜×¢×™× ×”
// (×›×“×™ ×©×–×” ×™×”×™×” "×ª××™×“ ××”×›×¤×ª×•×¨ ×”×¡×•×“×™")
(async () => {
  try {
    await signOut(auth);
  } catch {}
})();

// Auth flow
onAuthStateChanged(auth, async (user) => {
  if (user) {
    uid = user.uid;
    const email = user.email || null;

    // âœ… ×–×” ×”×ª×™×§×•×Ÿ ×”×¢×™×§×¨×™: ×× ×”×œ×ª ×œ×¤×™ ××™××™×™×œ (×•×’× UID ×›×’×™×‘×•×™)
    isAdmin = (email && email === ADMIN_EMAIL) || (user.uid === ADMIN_UID);

    statusEl.textContent = isAdmin ? "×× ×”×œ×ª" : "××•×¨×—";
    statusEl.className = isAdmin ? "ok" : "";

    adminPanel.classList.toggle("hidden", !isAdmin);
    loadRooms();
  } else {
    uid = null;
    isAdmin = false;
    statusEl.textContent = "××•×¨×—";
    statusEl.className = "";

    // ××•×¨×— ××•×˜×•××˜×™
    await signInAnonymously(auth);
  }
});

// Secret toggle
secretLogin.onclick = () => {
  loginCard.classList.toggle("hidden");
};

// Login admin
loginBtn.onclick = async () => {
  try {
    await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
    loginCard.classList.add("hidden");
  } catch (e) {
    console.error(e);
    alert("×©×’×™××ª ×”×ª×—×‘×¨×•×ª: " + (e.code || e.message));
  }
};

// Rooms list + ratings stats
function loadRooms() {
  onSnapshot(collection(db, "rooms"), (snap) => {
    roomsEl.innerHTML = "";

    snap.forEach((d) => {
      const r = d.data();
      const tr = document.createElement("tr");

      tr.innerHTML = `
        <td>${escapeHTML(r.name)}</td>
        <td>${escapeHTML(r.city || "")}</td>
        <td>${escapeHTML(String(r.score ?? ""))}</td>
        <td id="avg-${d.id}">â€”</td>
        <td id="cnt-${d.id}">0</td>
        <td class="actions"></td>
      `;

      const actions = tr.querySelector(".actions");

      const rateBtn = document.createElement("button");
      rateBtn.textContent = "×“×¨×’";
      rateBtn.className = "small";
      rateBtn.onclick = () => rate(d.id);
      actions.appendChild(rateBtn);

      if (isAdmin) {
        const editBtn = document.createElement("button");
        editBtn.textContent = "×¢×¨×•×š";
        editBtn.className = "small";
        editBtn.onclick = () => {
          editingId = d.id;
          nameEl.value = r.name || "";
          cityEl.value = r.city || "";
          scoreEl.value = String(r.score ?? "");
          formTitle.textContent = "×¢×¨×™×›×ª ×—×“×¨";
          window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
        };

        const delBtn = document.createElement("button");
        delBtn.textContent = "××—×§";
        delBtn.className = "small danger";
        delBtn.onclick = async () => {
          if (!confirm(`×œ××—×•×§ ××ª "${r.name}"?`)) return;
          await deleteDoc(doc(db, "rooms", d.id));
        };

        actions.append(editBtn, delBtn);
      }

      roomsEl.appendChild(tr);
      listenRatings(d.id);
    });
  });
}

function escapeHTML(s){
  return String(s ?? "").replace(/[&<>"']/g, m => ({
    "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
  }[m]));
}

// Save room (admin only)
saveBtn.onclick = async () => {
  if (!isAdmin) return alert("××™×Ÿ ×”×¨×©××”");

  const name = nameEl.value.trim();
  const city = cityEl.value.trim();
  const raw = scoreEl.value.trim();
  const s = parseInt(raw, 10);

  if (!name) return alert("×—×¡×¨ ×©× ×—×“×¨");
  if (raw === "" || Number.isNaN(s) || s < 1 || s > 10) return alert("×¦×™×•×Ÿ ×—×™×™×‘ ×œ×”×™×•×ª ××¡×¤×¨ ×©×œ× ×‘×™×Ÿ 1 ×œÖ¾10");

  try {
    if (editingId) {
      await updateDoc(doc(db, "rooms", editingId), { name, city, score: s });
      editingId = null;
      formTitle.textContent = "×”×•×¡×¤×ª ×—×“×¨";
    } else {
      await addDoc(collection(db, "rooms"), { name, city, score: s });
    }

    nameEl.value = "";
    cityEl.value = "";
    scoreEl.value = "";
    alert("× ×©××¨ âœ…");
  } catch (e) {
    console.error(e);
    alert("×©×’×™××” ×‘×©××™×¨×”: " + (e.code || e.message));
  }
};

// Rate (any logged-in user incl anonymous)
async function rate(roomId){
  const v = parseInt(prompt("×¦×™×•×Ÿ 1â€“10"), 10);
  if (Number.isNaN(v) || v < 1 || v > 10) return;

  try {
    await setDoc(
      doc(db, "ratings", `${roomId}_${uid}`),
      { roomId, uid, value: v },
      { merge: true }
    );
  } catch (e) {
    console.error(e);
    alert("×©×’×™××” ×‘×“×™×¨×•×’: " + (e.code || e.message));
  }
}

function listenRatings(roomId){
  const q = query(collection(db, "ratings"), where("roomId", "==", roomId));
  onSnapshot(q, (s) => {
    let sum = 0;
    s.forEach(d => sum += Number(d.data().value || 0));
    const avg = s.size ? (sum / s.size).toFixed(1) : "â€”";
    const avgEl = document.getElementById(`avg-${roomId}`);
    const cntEl = document.getElementById(`cnt-${roomId}`);
    if (avgEl) avgEl.textContent = avg;
    if (cntEl) cntEl.textContent = String(s.size);
  });
}

// Excel Import (admin only)
importBtn.onclick = () => {
  if (!isAdmin) return alert("××™×Ÿ ×”×¨×©××”");

  const file = excelFile.files[0];
  if (!file) return alert("×œ× × ×‘×—×¨ ×§×•×‘×¥");

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const wb = XLSX.read(e.target.result, { type: "binary" });
      const rows = XLSX.utils.sheet_to_json(wb.Sheets[wb.SheetNames[0]]);

      let added = 0;
      for (const row of rows) {
        const n = String(row.name ?? "").trim();
        const c = String(row.city ?? "").trim();
        const s = parseInt(String(row.score ?? "").trim(), 10);

        if (!n) continue;
        if (Number.isNaN(s) || s < 1 || s > 10) continue;

        await addDoc(collection(db, "rooms"), { name: n, city: c, score: s });
        added++;
      }

      alert(`× ×•×¡×¤×• ${added} ×—×“×¨×™× âœ…`);
      excelFile.value = "";
    } catch (err) {
      console.error(err);
      alert("×©×’×™××” ×‘×™×™×‘×•×: " + (err.message || err));
    }
  };
  reader.readAsBinaryString(file);
};
</script>

</body>
</html>
