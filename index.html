<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Clueless</title>

  <style>
    body{
      margin:0;
      font-family:system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      background:#0b1020;
      color:#eef2ff;
    }
    header,main{max-width:1000px;margin:auto;padding:20px}
    h1{margin-top:0}
    input,select,textarea,button{
      width:100%;padding:10px;margin:6px 0;
      border-radius:8px;border:1px solid #334;
      background:#111a33;color:#fff;
    }
    button{cursor:pointer;background:#7c3aed;font-weight:700}
    table{width:100%;border-collapse:collapse;margin-top:20px}
    th,td{border-bottom:1px solid #334;padding:10px;text-align:right}
    tr:hover{background:#111a33}
    .card{border:1px solid #334;border-radius:12px;padding:16px;margin-bottom:20px}
    .pill{display:inline-block;padding:4px 10px;border-radius:20px;background:#111a33}
    .ok{color:#22c55e}
  </style>
</head>

<body>

<header>
  <h1>Clueless ğŸ§©</h1>
  <p class="pill">×¡×˜×˜×•×¡: <span id="status">××ª×—×‘×¨â€¦</span></p>
</header>

<main>

  <section class="card">
    <h2>×”×•×¡×¤×ª ×—×“×¨</h2>
    <input id="name" placeholder="×©× ×”×—×“×¨">
    <input id="city" placeholder="×¢×™×¨">
    <input id="score" type="number" min="0" max="10" step="0.5" placeholder="×”×¦×™×•×Ÿ ×©×œ×š">
    <button id="addRoom">×©××•×¨ ×—×“×¨</button>
  </section>

  <section class="card">
    <h2>×—×“×¨×™×</h2>
    <table>
      <thead>
        <tr>
          <th>×©×</th>
          <th>×¢×™×¨</th>
          <th>×”×¦×™×•×Ÿ ×©×œ×™</th>
          <th>×××•×¦×¢ ×§×”×™×œ×”</th>
          <th>×“×¨×’</th>
        </tr>
      </thead>
      <tbody id="rooms"></tbody>
    </table>
  </section>

</main>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, setDoc, doc,
    onSnapshot, query, where
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  /* ======== Firebase CONFIG (×©×œ×š) ======== */
  const firebaseConfig = {
    apiKey: "AIzaSyCuaw5E-SJM3ojbw6vhj4gw6MSjId4wosw",
    authDomain: "unlocked-67483.firebaseapp.com",
    projectId: "unlocked-67483",
    storageBucket: "unlocked-67483.firebasestorage.app",
    messagingSenderId: "565517769840",
    appId: "1:565517769840:web:aeb892e7ea92713a4e28b5",
    measurementId: "G-DWR98E9XQ0"
  };

  /* ======== Init ======== */
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const statusEl = document.getElementById("status");
  const roomsEl = document.getElementById("rooms");

  let uid = null;

  onAuthStateChanged(auth, user => {
    if(user){
      uid = user.uid;
      statusEl.textContent = "××—×•×‘×¨";
      statusEl.className = "ok";
      loadRooms();
    }
  });

  await signInAnonymously(auth);

  /* ======== Rooms ======== */
  document.getElementById("addRoom").onclick = async () => {
    const name = document.getElementById("name").value.trim();
    const city = document.getElementById("city").value.trim();
    const score = Number(document.getElementById("score").value);

    if(!name) return alert("×—×¡×¨ ×©× ×—×“×¨");

    await addDoc(collection(db,"rooms"),{
      name, city, score,
      owner: uid
    });

    document.getElementById("name").value="";
    document.getElementById("city").value="";
    document.getElementById("score").value="";
  };

  function loadRooms(){
    onSnapshot(collection(db,"rooms"), snap=>{
      roomsEl.innerHTML="";
      snap.forEach(docSnap=>{
        const r = docSnap.data();
        const tr = document.createElement("tr");

        const rateBtn = document.createElement("button");
        rateBtn.textContent = "×“×¨×’";
        rateBtn.onclick = ()=>rate(docSnap.id);

        tr.innerHTML = `
          <td>${r.name}</td>
          <td>${r.city||""}</td>
          <td>${r.score ?? "â€”"}</td>
          <td id="avg-${docSnap.id}">â€”</td>
          <td></td>
        `;
        tr.children[4].appendChild(rateBtn);
        roomsEl.appendChild(tr);

        listenAvg(docSnap.id);
      });
    });
  }

  /* ======== Ratings ======== */
  async function rate(roomId){
    const value = prompt("×¦×™×•×Ÿ 0â€“10");
    if(value===null) return;

    await setDoc(doc(db,"ratings",`${roomId}_${uid}`),{
      roomId, uid, value:Number(value)
    });
  }

  function listenAvg(roomId){
    const q = query(collection(db,"ratings"), where("roomId","==",roomId));
    onSnapshot(q,snap=>{
      let sum=0;
      snap.forEach(d=>sum+=Number(d.data().value));
      const avg = snap.size ? (sum/snap.size).toFixed(1) : "â€”";
      const el = document.getElementById(`avg-${roomId}`);
      if(el) el.textContent = avg;
    });
  }
</script>

</body>
</html>
