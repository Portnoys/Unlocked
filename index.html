importBtn.onclick = () => {
  if (!isAdmin) return alert("אין הרשאה");

  const file = excelFile.files[0];
  if (!file) return alert("לא נבחר קובץ");

  const reader = new FileReader();
  reader.onload = async (e) => {
    try {
      const wb = XLSX.read(e.target.result, { type: "binary" });

      // לוקחים את הגיליון הראשון (או "חדרים" אם קיים)
      const sheetName = wb.SheetNames.includes("חדרים") ? "חדרים" : wb.SheetNames[0];
      const sheet = wb.Sheets[sheetName];

      // קוראים כטבלה: מערך של שורות (header: 1)
      const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });

      if (data.length < 2) {
        alert("הקובץ ריק או שיש רק כותרות בלי נתונים");
        return;
      }

      // כותרות (שורה ראשונה)
      const headers = data[0].map(h => String(h).trim().toLowerCase());

      // מוצאים עמודות לפי כותרת; אם לא נמצא—ברירת מחדל: 0,1,2
      const col = (names, fallback) => {
        const idx = headers.findIndex(h => names.includes(h));
        return idx >= 0 ? idx : fallback;
      };

      const colName  = col(["name","שם"], 0);
      const colCity  = col(["city","עיר"], 1);
      const colScore = col(["score","ציון","הציון שלי"], 2);

      let added = 0;
      let skipped = 0;
      const skipSamples = [];

      // batch (עד 450 כתיבות בכל commit כדי להיות בטוחים)
      let batch = writeBatch(db);
      let batchCount = 0;

      for (let i = 1; i < data.length; i++) {
        const row = data[i];

        const name = String(row[colName] ?? "").trim();
        const city = String(row[colCity] ?? "").trim();

        const rawScore = String(row[colScore] ?? "").trim();
        const score = parseInt(rawScore, 10);

        // ולידציה
        if (!name) {
          skipped++;
          if (skipSamples.length < 5) skipSamples.push(`שורה ${i+1}: חסר name`);
          continue;
        }
        if (Number.isNaN(score) || score < 1 || score > 10) {
          skipped++;
          if (skipSamples.length < 5) skipSamples.push(`שורה ${i+1}: score לא תקין (${rawScore})`);
          continue;
        }

        // מכינים מסמך חדש (ID אוטומטי) בתוך batch
        const ref = doc(collection(db, "rooms"));
        batch.set(ref, { name, city, score });

        added++;
        batchCount++;

        // commit כל 450 כתיבות
        if (batchCount >= 450) {
          await batch.commit();
          batch = writeBatch(db);
          batchCount = 0;
        }
      }

      // commit אחרון
      if (batchCount > 0) await batch.commit();

      let msg = `✅ נוספו ${added} חדרים (גיליון: ${sheetName})`;
      if (skipped) msg += `\n⚠️ דולגו ${skipped} שורות לא תקינות.`;
      if (skipSamples.length) msg += `\nדוגמאות:\n- ${skipSamples.join("\n- ")}`;

      alert(msg);
      excelFile.value = "";

    } catch (err) {
      console.error(err);
      alert("שגיאה בייבוא: " + (err.code || err.message || err));
    }
  };

  reader.readAsBinaryString(file);
};
