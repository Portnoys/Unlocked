<!doctype html>
<html lang="he" dir="rtl">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>UNLOCKED</title>

  <script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

  <style>
    :root{
      --bg:#0b1020; --line:#2b3566;
      --accent:#8b5cf6; --accent2:#22d3ee;
      --text:#f8fafc; --muted:#c7d2fe; --good:#22c55e;
      --danger:#ef4444;
    }
    body{
      margin:0;
      font-family: system-ui,-apple-system,Segoe UI,Arial,sans-serif;
      background: radial-gradient(1200px 650px at 10% -10%, #1e2a78, var(--bg));
      color:var(--text);
      font-size:19px;
    }

    main{max-width:1200px;margin:auto;padding:24px}

    h1{margin:0;font-size:42px}
    h2{margin:0 0 12px;font-size:28px}

    .card{
      background: linear-gradient(180deg, rgba(255,255,255,.09), rgba(255,255,255,.02));
      border: 1px solid var(--line);
      border-radius: 22px;
      padding: 26px;
      margin-bottom: 28px;
      box-shadow:0 22px 60px rgba(0,0,0,.35);
    }

    .row{display:grid;grid-template-columns:1fr 1fr;gap:12px}
    @media (max-width:780px){.row{grid-template-columns:1fr}}

    input,button{
      width:100%;
      padding:16px;
      margin:8px 0;
      border-radius:14px;
      border:1px solid var(--line);
      background:#0b1020;
      color:var(--text);
      font-size:18px;
      box-sizing:border-box;
    }
    input[type="file"]{padding:12px}
    button{
      background: linear-gradient(90deg, var(--accent), var(--accent2));
      border:none;
      font-weight:800;
      cursor:pointer;
    }
    button.small{
      width:auto;
      padding:8px 14px;
      font-size:15px;
      border-radius:12px;
      margin-left:6px;
    }
    button.danger{background:var(--danger)}

    table{width:100%;border-collapse:collapse;font-size:18px}
    th,td{padding:16px;border-bottom:1px solid var(--line);text-align:right;vertical-align:middle}
    th{color:var(--muted);font-weight:700}
    tr:hover{background:rgba(255,255,255,.04)}

    .hidden{display:none}
    .muted{color:var(--muted);font-size:14px;line-height:1.6}
    hr{border:0;border-top:1px solid var(--line);margin:22px 0}

    /* ğŸ¥· secret admin dot */
    #secretLogin{
      position:fixed;bottom:6px;left:6px;width:10px;height:10px;border-radius:50%;
      background: rgba(255,255,255,.15);cursor:pointer;z-index:9999;
    }
    #secretLogin:hover{background: rgba(139,92,246,.9)}

    /* modal */
    .modalOverlay{
      position:fixed; inset:0;
      background: rgba(0,0,0,.55);
      display:flex;
      align-items:center;
      justify-content:center;
      padding:18px;
      z-index:10000;
    }
    .modalOverlay.hidden{ display:none !important; }

    .modal{
      width:min(720px, 100%);
      background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.03));
      border:1px solid var(--line);
      border-radius:22px;
      padding:22px;
      box-shadow:0 22px 60px rgba(0,0,0,.55);
    }
    .modal h3{margin:0 0 10px; font-size:24px}
    .modalActions{display:flex; gap:10px; margin-top:14px}
    .modalActions button{flex:1}
    .checkboxRow{
      display:flex; gap:10px; align-items:flex-start;
      padding:12px; border:1px solid var(--line); border-radius:14px;
      background:#0b1020;
      margin-top:10px;
    }
    .checkboxRow input{width:auto; margin-top:4px}
    .checkboxRow label{font-size:16px; color:var(--text)}

    #status { display:none; }

    .top-bar{
      position: sticky;
      top: 0;
      z-index: 1000;
      background: #000;
      height: 120px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      align-items: center;
      padding: 0 24px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.6);
    }

    .contact-link{
      justify-self: start;
      color:#fff;
      text-decoration:none;
      padding: 8px 16px;
      border: 1px solid #333;
      border-radius: 999px;
      font-size: 16px;
      background: rgba(255,255,255,0.06);
    }
    .contact-link:hover{background: rgba(255,255,255,0.12);}

    .site-logo{
      justify-self: center;
      max-height: 120px;
      width: auto;
      display:block;
    }

    .right-spacer{ width: 120px; }

    @media (max-width: 700px){
      .top-bar{
        grid-template-columns: 1fr;
        height: auto;
        gap: 12px;
        padding: 12px;
      }
      .contact-link{justify-self:center}
      .site-logo{max-height: 56px}
      .right-spacer{display:none}
    }
  </style>
</head>

<body>

<header class="top-bar">
  <a href="mailto:sigalp@gmail.com?subject=×¤× ×™×™×” ×××ª×¨ UNLOCKED" class="contact-link">
    ×¦×•×¨ ×§×©×¨
  </a>

  <img src="unlocked-logo.png" alt="UNLOCKED logo" class="site-logo" />

  <div class="right-spacer"></div>
  <span id="status" style="display:none">×˜×•×¢×Ÿâ€¦</span>
</header>

<main>
  <section class="card hidden" id="loginCard">
    <h2>×”×ª×—×‘×¨×•×ª ×× ×”×œ×ª</h2>
    <div class="row">
      <input id="email" placeholder="××™×™×œ">
      <input id="password" type="password" placeholder="×¡×™×¡××”">
    </div>
    <button id="loginBtn">×”×ª×—×‘×¨×™</button>
    <p class="muted">×”×˜×•×¤×¡ × ×¤×ª×— ×¨×§ ××”× ×§×•×“×” ×”×¡×•×“×™×ª. ××—×¨×™ ×¨×¢× ×•×Ÿ ×—×•×–×¨×™× ×œ××•×¨×—.</p>
  </section>

  <section class="card">
    <h2>×—×“×¨×™× (×××•×™×™×Ÿ ×œ×¤×™ ×“×™×¨×•×’ ×›×•×œ×œ)</h2>
    <p class="muted">
      ×”××™×•×Ÿ × ×¢×©×” ×œ×¤×™ ×××•×¦×¢ ×›×•×œ×œ: (×¦×™×•×Ÿ ×”××ª×¨ + ×›×œ ×“×™×¨×•×’×™ ×”×§×”×™×œ×”) / (××¡×¤×¨ ××“×¨×’×™× + 1).
      ×‘×©×•×•×™×•×Ÿ â€” ××™ ×©×§×™×‘×œ ×™×•×ª×¨ ×“×™×¨×•×’×™× ××”×§×”×™×œ×” ×™×•×¤×™×¢ ×œ××¢×œ×”.
    </p>
    <table>
      <thead>
        <tr>
          <th>×©×</th>
          <th>×¢×™×¨</th>
          <th>×¦×™×•×Ÿ ×”××ª×¨</th>
          <th>×××•×¦×¢ ×§×”×™×œ×”</th>
          <th>×“×™×¨×’×•</th>
          <th>×“×™×¨×•×’ ×›×•×œ×œ</th>
          <th>×¤×¢×•×œ×•×ª</th>
        </tr>
      </thead>
      <tbody id="rooms"></tbody>
    </table>
  </section>

  <section class="card hidden" id="adminPanel">
    <h2 id="formTitle">×”×•×¡×¤×ª ×—×“×¨</h2>

    <div class="row">
      <input id="name" placeholder="×©× ×”×—×“×¨">
      <input id="city" placeholder="×¢×™×¨">
    </div>

    <input id="score" type="number" min="1" max="10" step="1" inputmode="numeric" placeholder="×¦×™×•×Ÿ ×”×™×•×¦×¨/×ª (1â€“10, ×©×œ× ×‘×œ×‘×“)">
    <button id="saveBtn">×©××•×¨</button>

    <hr>

    <h2>ğŸ“¥ ×”×¢×œ××ª ×§×•×‘×¥ Excel</h2>
    <p class="muted">×›×•×ª×¨×•×ª × ×ª××›×•×ª: name/city/score ××• ×©×/×¢×™×¨/×¦×™×•×Ÿ.</p>
    <input type="file" id="excelFile" accept=".xlsx">
    <button id="importBtn">×™×™×‘×•× ×—×“×¨×™×</button>

    <hr>

    <h2>ğŸ“¥ ×™×™×‘×•× ×“×™×¨×•×’×™ ×§×”×™×œ×” (×¢××•×“×•×ª C + D)</h2>
    <p class="muted">
      ×”×§×•×‘×¥ ×¦×¨×™×š ×œ×›×œ×•×œ: ×©× + ×¢×™×¨ (×›××• ×‘××ª×¨), ×•×‘×¢××•×“×•×ª C ×•-D ×“×™×¨×•×’×™× (1â€“10) ×©×œ ×©× ×™ ×× ×©×™× ×§×‘×•×¢×™×.
      ×× ×ª× ×¨×™×§ â€“ ×œ× ×™×™×›× ×¡ ×“×™×¨×•×’.
    </p>
    <input type="file" id="ratingsExcelFile" accept=".xlsx">
    <button id="importRatingsBtn">×™×™×‘×•× ×“×™×¨×•×’×™× (C + D)</button>
  </section>
</main>

<div id="secretLogin" title="admin"></div>

<div id="pledgeOverlay" class="modalOverlay hidden" role="dialog" aria-modal="true">
  <div class="modal" id="pledgeModal">
    <h3 id="pledgeTitle">×“×™×¨×•×’ ×—×“×¨</h3>

    <div class="checkboxRow">
      <input type="checkbox" id="pledgeCheck">
      <label for="pledgeCheck">
        ×× ×™ ××ª×—×™×™×‘/×ª ×©×”×™×™×ª×™ ×‘×—×“×¨ ×”×–×” ×‘××”×œ×š ×”×—×•×“×© ×”××—×¨×•×Ÿ, ×•×©×–×• ×”×¤×¢× ×”×¨××©×•× ×” (×•×”××—×¨×•× ×”...) ×©×× ×™ ××“×¨×’/×ª ××•×ª×•.
      </label>
    </div>

    <div class="modalActions">
      <button id="pledgeCancelBtn" class="danger">×‘×™×˜×•×œ</button>
      <button id="pledgeConfirmBtn">×××©×¨/×ª</button>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-app.js";
  import { getAuth, signInAnonymously, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-auth.js";
  import {
    getFirestore, collection, addDoc, updateDoc, deleteDoc, doc,
    onSnapshot, query, where, setDoc, writeBatch
  } from "https://www.gstatic.com/firebasejs/10.12.5/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyCuaw5E-SJM3ojbw6vhj4gw6MSjId4wosw",
    authDomain: "unlocked-67483.firebaseapp.com",
    projectId: "unlocked-67483",
    storageBucket: "unlocked-67483.firebasestorage.app",
    messagingSenderId: "565517769840",
    appId: "1:565517769840:web:aeb892e7ea92713a4e28b5"
  };

  const ADMIN_EMAIL = "sigalp@gmail.com";

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const statusEl   = document.getElementById("status");
  const roomsEl    = document.getElementById("rooms");
  const adminPanel = document.getElementById("adminPanel");
  const loginCard  = document.getElementById("loginCard");
  const secretDot  = document.getElementById("secretLogin");

  const emailEl  = document.getElementById("email");
  const passEl   = document.getElementById("password");
  const loginBtn = document.getElementById("loginBtn");

  const nameEl    = document.getElementById("name");
  const cityEl    = document.getElementById("city");
  const scoreEl   = document.getElementById("score");
  const saveBtn   = document.getElementById("saveBtn");
  const formTitle = document.getElementById("formTitle");

  const excelFile = document.getElementById("excelFile");
  const importBtn = document.getElementById("importBtn");

  const ratingsExcelFile = document.getElementById("ratingsExcelFile");
  const importRatingsBtn = document.getElementById("importRatingsBtn");

  const pledgeOverlay    = document.getElementById("pledgeOverlay");
  const pledgeModal      = document.getElementById("pledgeModal");
  const pledgeTitle      = document.getElementById("pledgeTitle");
  const pledgeCheck      = document.getElementById("pledgeCheck");
  const pledgeCancelBtn  = document.getElementById("pledgeCancelBtn");
  const pledgeConfirmBtn = document.getElementById("pledgeConfirmBtn");

  let uid = null;
  let isAdmin = false;
  let editingId = null;
  let pendingRate = null;

  try { await signOut(auth); } catch {}

  secretDot.onclick = () => loginCard.classList.toggle("hidden");

  // ===== NEW: caches + single listeners (rooms + ratings) =====
  let roomsCache = [];          // [{id, name, city, score}]
  let ratingsAgg = new Map();   // roomId -> {sum, count}
  let roomsUnsub = null;
  let ratingsUnsub = null;

  function startGlobalListeners(){
    if (!roomsUnsub) {
      roomsUnsub = onSnapshot(
        query(collection(db, "rooms")),
        (snap) => {
          roomsCache = [];
          snap.forEach((d) => roomsCache.push({ id: d.id, ...d.data() }));
          renderRoomsSorted();
        },
        (err) => {
          console.error("Rooms read error:", err);
          alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×—×“×¨×™×: " + (err.code || err.message));
          roomsEl.innerHTML = "";
        }
      );
    }

    if (!ratingsUnsub) {
      ratingsUnsub = onSnapshot(
        collection(db, "ratings"),
        (snap) => {
          const m = new Map();
          snap.forEach((d) => {
            const r = d.data();
            const roomId = r.roomId;
            const v = Number(r.value || 0);
            if (!roomId || !Number.isFinite(v)) return;

            const cur = m.get(roomId) || { sum: 0, count: 0 };
            cur.sum += v;
            cur.count += 1;
            m.set(roomId, cur);
          });
          ratingsAgg = m;
          renderRoomsSorted();
        },
        (err) => {
          console.error("Ratings read error:", err);
          ratingsAgg = new Map();
          renderRoomsSorted();
        }
      );
    }
  }

  function renderRoomsSorted(){
    const rows = roomsCache.map((r) => {
      const comm = ratingsAgg.get(r.id) || { sum: 0, count: 0 };

      const myScore = Number(r.score ?? 0);
      const commSum = Number(comm.sum ?? 0);
      const commCount = Number(comm.count ?? 0);

      // ×ª××™×“ ×™×© ×¦×™×•×Ÿ ××ª×¨ (×©×œ×š), ××‘×œ × ×©××•×¨ ×¢×œ ×–×” ×™×¦×™×‘
      const includeMy = Number.isFinite(myScore) && myScore > 0;

      const totalCount = includeMy ? (1 + commCount) : commCount;
      const totalSum   = includeMy ? (myScore + commSum) : commSum;

      const combinedAvg = totalCount ? (totalSum / totalCount) : -999;
      const communityAvg = commCount ? (commSum / commCount) : null;

      return {
        ...r,
        communitySum: commSum,
        communityCount: commCount,
        communityAvg,
        combinedAvg
      };
    });

    // âœ… sort: combinedAvg desc, then communityCount desc, then name
    rows.sort((a, b) => {
      const d1 = (b.combinedAvg - a.combinedAvg);
      if (Math.abs(d1) > 1e-9) return d1;

      const d2 = (b.communityCount - a.communityCount);
      if (d2 !== 0) return d2;

      return String(a.name || "").localeCompare(String(b.name || ""), "he");
    });

    roomsEl.innerHTML = "";

    for (const r of rows) {
      const tr = document.createElement("tr");

      const commAvgText = (r.communityAvg == null) ? "â€”" : r.communityAvg.toFixed(1);
      const combinedText = (r.combinedAvg <= -900) ? "â€”" : r.combinedAvg.toFixed(1);

      tr.innerHTML = `
        <td>${escapeHTML(r.name)}</td>
        <td>${escapeHTML(r.city || "")}</td>
        <td>${escapeHTML(String(r.score ?? ""))}</td>
        <td>${escapeHTML(commAvgText)}</td>
        <td>${escapeHTML(String(r.communityCount || 0))}</td>
        <td><strong>${escapeHTML(combinedText)}</strong></td>
        <td class="actions"></td>
      `;

      const actions = tr.querySelector(".actions");

      const rateBtn = document.createElement("button");
      rateBtn.textContent = "×“×¨×’";
      rateBtn.className = "small";
      rateBtn.onclick = () => startRateFlow(r.id, r.name);
      actions.appendChild(rateBtn);

      if (isAdmin) {
        const editBtn = document.createElement("button");
        editBtn.textContent = "×¢×¨×•×š";
        editBtn.className = "small";
        editBtn.onclick = () => {
          editingId = r.id;
          nameEl.value = r.name || "";
          cityEl.value = r.city || "";
          scoreEl.value = String(r.score ?? "");
          formTitle.textContent = "×¢×¨×™×›×ª ×—×“×¨";
          window.scrollTo({ top: document.body.scrollHeight, behavior: "smooth" });
        };

        const delBtn = document.createElement("button");
        delBtn.textContent = "××—×§";
        delBtn.className = "small danger";
        delBtn.onclick = async () => {
          if (!confirm(`×œ××—×•×§ ××ª "${r.name}"?`)) return;
          try { await deleteDoc(doc(db, "rooms", r.id)); }
          catch (e) { console.error(e); alert("×©×’×™××” ×‘××—×™×§×”: " + (e.code || e.message)); }
        };

        actions.append(editBtn, delBtn);
      }

      roomsEl.appendChild(tr);
    }
  }
  // ===== END NEW =====

  onAuthStateChanged(auth, async (user) => {
    if (!user) {
      uid = null;
      isAdmin = false;
      if (statusEl) statusEl.textContent = "××•×¨×—";
      adminPanel.classList.add("hidden");
      await signInAnonymously(auth);
      return;
    }

    uid = user.uid;
    const currentEmail = (user.email || "").toLowerCase().trim();
    const adminEmail = (ADMIN_EMAIL || "").toLowerCase().trim();
    isAdmin = adminEmail !== "" && currentEmail === adminEmail;

    if (statusEl) statusEl.textContent = isAdmin ? "×× ×”×œ×ª" : "××•×¨×—";
    adminPanel.classList.toggle("hidden", !isAdmin);

    startGlobalListeners(); // âœ… replaces loadRooms()
  });

  loginBtn.onclick = async () => {
    try {
      await signInWithEmailAndPassword(auth, emailEl.value.trim(), passEl.value);
      loginCard.classList.add("hidden");
    } catch (e) {
      console.error(e);
      alert("×©×’×™××ª ×”×ª×—×‘×¨×•×ª: " + (e.code || e.message));
    }
  };

  saveBtn.onclick = async () => {
    if (!isAdmin) return alert("××™×Ÿ ×”×¨×©××”");

    const name = nameEl.value.trim();
    const city = cityEl.value.trim();
    const rawScore = scoreEl.value.trim();
    const s = parseInt(rawScore, 10);

    if (!name) return alert("×—×¡×¨ ×©× ×—×“×¨");
    if (rawScore === "" || Number.isNaN(s) || s < 1 || s > 10) {
      return alert("×¦×™×•×Ÿ ×—×™×™×‘ ×œ×”×™×•×ª ××¡×¤×¨ ×©×œ× ×‘×™×Ÿ 1 ×œÖ¾10");
    }

    try {
      if (editingId) {
        await updateDoc(doc(db, "rooms", editingId), { name, city, score: s });
        editingId = null;
        formTitle.textContent = "×”×•×¡×¤×ª ×—×“×¨";
      } else {
        await addDoc(collection(db, "rooms"), { name, city, score: s });
      }

      nameEl.value = "";
      cityEl.value = "";
      scoreEl.value = "";
      alert("× ×©××¨ âœ…");
    } catch (e) {
      console.error(e);
      alert("×©×’×™××” ×‘×©××™×¨×”: " + (e.code || e.message));
    }
  };

  function startRateFlow(roomId, roomName){
    const v = parseInt(prompt("×¦×™×•×Ÿ 1â€“10"), 10);
    if (Number.isNaN(v) || v < 1 || v > 10) return;

    pendingRate = { roomId, value: v, roomName };
    pledgeTitle.textContent = `×“×™×¨×•×’: ${roomName}`;
    pledgeCheck.checked = false;
    pledgeOverlay.classList.remove("hidden");
  }

  function closePledge(){
    pledgeOverlay.classList.add("hidden");
    pendingRate = null;
    pledgeCheck.checked = false;
  }

  pledgeCancelBtn.onclick = closePledge;
  pledgeOverlay.addEventListener("click", (e) => { if (e.target === pledgeOverlay) closePledge(); });
  pledgeModal.addEventListener("click", (e) => e.stopPropagation());
  document.addEventListener("keydown", (e) => {
    if (e.key === "Escape" && !pledgeOverlay.classList.contains("hidden")) closePledge();
  });

  pledgeConfirmBtn.onclick = async () => {
    if (!pendingRate) return;
    if (!pledgeCheck.checked) return alert("×¦×¨×™×š ×œ×¡××Ÿ ×”×¡×›××” ×›×“×™ ×œ×¢×“×›×Ÿ ×“×™×¨×•×’.");

    const { roomId, value } = pendingRate;
    try {
      await setDoc(
        doc(db, "ratings", `${roomId}_${uid}`),
        { roomId, uid, value, pledgeAccepted:true, pledgedAt: Date.now() },
        { merge:true }
      );
      closePledge();
    } catch (e) {
      console.error(e);
      alert("×©×’×™××” ×‘×“×™×¨×•×’: " + (e.code || e.message));
    }
  };

  // âœ… ×™×™×‘×•× ×—×“×¨×™×
  importBtn.onclick = () => {
    if (!isAdmin) return alert("××™×Ÿ ×”×¨×©××”");

    const file = excelFile.files[0];
    if (!file) return alert("×œ× × ×‘×—×¨ ×§×•×‘×¥");

    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const wb = XLSX.read(e.target.result, { type: "binary" });
        const sheetName = wb.SheetNames.includes("×—×“×¨×™×") ? "×—×“×¨×™×" : wb.SheetNames[0];
        const sheet = wb.Sheets[sheetName];

        const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
        if (data.length < 2) return alert("×”×§×•×‘×¥ ×¨×™×§ ××• ×©×™×© ×¨×§ ×›×•×ª×¨×•×ª ×‘×œ×™ × ×ª×•× ×™×");

        const headers = data[0].map(h => String(h).trim().toLowerCase());
        const col = (names, fallback) => {
          const idx = headers.findIndex(h => names.includes(h));
          return idx >= 0 ? idx : fallback;
        };

        const colName  = col(["name","×©×"], 0);
        const colCity  = col(["city","×¢×™×¨"], 1);
        const colScore = col(["score","×¦×™×•×Ÿ","×”×¦×™×•×Ÿ ×©×œ×™"], 2);

        let added = 0, skipped = 0;
        const skipSamples = [];

        let batch = writeBatch(db);
        let batchCount = 0;

        for (let i = 1; i < data.length; i++) {
          const row = data[i];

          const name = String(row[colName] ?? "").trim();
          const city = String(row[colCity] ?? "").trim();
          const rawScore = String(row[colScore] ?? "").trim();
          const score = parseInt(rawScore, 10);

          if (!name) { skipped++; if (skipSamples.length < 5) skipSamples.push(`×©×•×¨×” ${i+1}: ×—×¡×¨ name`); continue; }
          if (Number.isNaN(score) || score < 1 || score > 10) {
            skipped++; if (skipSamples.length < 5) skipSamples.push(`×©×•×¨×” ${i+1}: score ×œ× ×ª×§×™×Ÿ (${rawScore})`);
            continue;
          }

          const ref = doc(collection(db, "rooms"));
          batch.set(ref, { name, city, score });

          added++; batchCount++;

          if (batchCount >= 450) {
            await batch.commit();
            batch = writeBatch(db);
            batchCount = 0;
          }
        }

        if (batchCount > 0) await batch.commit();

        let msg = `âœ… × ×•×¡×¤×• ${added} ×—×“×¨×™×`;
        if (skipped) msg += `\nâš ï¸ ×“×•×œ×’×• ${skipped} ×©×•×¨×•×ª ×œ× ×ª×§×™× ×•×ª.`;
        if (skipSamples.length) msg += `\n×“×•×’×××•×ª:\n- ${skipSamples.join("\n- ")}`;

        alert(msg);
        excelFile.value = "";
      } catch (err) {
        console.error(err);
        alert("×©×’×™××” ×‘×™×™×‘×•×: " + (err.code || err.message || err));
      }
    };

    reader.readAsBinaryString(file);
  };

  // âœ… ×™×™×‘×•× ×“×™×¨×•×’×™× (C + D)
  importRatingsBtn.onclick = async () => {
    if (!isAdmin) return alert("××™×Ÿ ×”×¨×©××”");

    const file = ratingsExcelFile.files[0];
    if (!file) return alert("×œ× × ×‘×—×¨ ×§×•×‘×¥");

    // ××¤×” ×©×œ ×—×“×¨×™× ×§×™×™××™×: "name||city" -> roomId
    let roomsMap = new Map();
    try {
      await new Promise((resolve, reject) => {
        const unsub = onSnapshot(
          query(collection(db, "rooms")),
          (snap) => {
            roomsMap = new Map();
            snap.forEach((d) => {
              const r = d.data();
              roomsMap.set(normalizeKey(r.name, r.city), d.id);
            });
            unsub();
            resolve();
          },
          (err) => reject(err)
        );
      });
    } catch (e) {
      console.error(e);
      return alert("×©×’×™××” ×‘×˜×¢×™× ×ª ×”×—×“×¨×™× ××”××ª×¨: " + (e.code || e.message));
    }

    const reader = new FileReader();
    reader.onload = async (e) => {
      try {
        const wb = XLSX.read(e.target.result, { type: "binary" });
        const sheetName = wb.SheetNames.includes("×—×“×¨×™×") ? "×—×“×¨×™×" : wb.SheetNames[0];
        const sheet = wb.Sheets[sheetName];

        const data = XLSX.utils.sheet_to_json(sheet, { header: 1, defval: "" });
        if (data.length < 2) return alert("×”×§×•×‘×¥ ×¨×™×§ ××• ×™×© ×¨×§ ×›×•×ª×¨×•×ª");

        const headers = data[0].map(h => String(h).trim().toLowerCase());
        const col = (names, fallback) => {
          const idx = headers.findIndex(h => names.includes(h));
          return idx >= 0 ? idx : fallback;
        };

        const colName = col(["name","×©×"], 0);
        const colCity = col(["city","×¢×™×¨","××§×•×"], 1);

        const colR1 = 2; // C
        const colR2 = 3; // D

        const communityUid1 = "community_1";
        const communityUid2 = "community_2";

        let added = 0;
        let skipped = 0;
        const skipSamples = [];

        let batch = writeBatch(db);
        let batchCount = 0;

        for (let i = 1; i < data.length; i++) {
          const row = data[i];

          const name = String(row[colName] ?? "").trim();
          const city = String(row[colCity] ?? "").trim();

          if (!name) { skipped++; if (skipSamples.length < 5) skipSamples.push(`×©×•×¨×” ${i+1}: ×—×¡×¨ ×©×`); continue; }

          const roomId = roomsMap.get(normalizeKey(name, city));
          if (!roomId) {
            skipped++;
            if (skipSamples.length < 5) skipSamples.push(`×©×•×¨×” ${i+1}: ×œ× × ××¦× ×—×“×¨ ×‘××ª×¨ (${name} / ${city})`);
            continue;
          }

          const raw1 = String(row[colR1] ?? "").trim();
          if (raw1 !== "") {
            const v1 = parseInt(raw1, 10);
            if (Number.isNaN(v1) || v1 < 1 || v1 > 10) {
              skipped++;
              if (skipSamples.length < 5) skipSamples.push(`×©×•×¨×” ${i+1}: ×“×™×¨×•×’ C ×œ× ×ª×§×™×Ÿ (${raw1})`);
            } else {
              const ref1 = doc(db, "ratings", `${roomId}_${communityUid1}`);
              batch.set(ref1, {
                roomId, uid: communityUid1, value: v1,
                pledgeAccepted: true, imported: true, importedAt: Date.now()
              }, { merge: true });
              added++; batchCount++;
            }
          }

          const raw2 = String(row[colR2] ?? "").trim();
          if (raw2 !== "") {
            const v2 = parseInt(raw2, 10);
            if (Number.isNaN(v2) || v2 < 1 || v2 > 10) {
              skipped++;
              if (skipSamples.length < 5) skipSamples.push(`×©×•×¨×” ${i+1}: ×“×™×¨×•×’ D ×œ× ×ª×§×™×Ÿ (${raw2})`);
            } else {
              const ref2 = doc(db, "ratings", `${roomId}_${communityUid2}`);
              batch.set(ref2, {
                roomId, uid: communityUid2, value: v2,
                pledgeAccepted: true, imported: true, importedAt: Date.now()
              }, { merge: true });
              added++; batchCount++;
            }
          }

          if (batchCount >= 450) {
            await batch.commit();
            batch = writeBatch(db);
            batchCount = 0;
          }
        }

        if (batchCount > 0) await batch.commit();

        let msg = `âœ… × ×•×¡×¤×•/×¢×•×“×›× ×• ${added} ×“×™×¨×•×’×™× (C+D)`;
        if (skipped) msg += `\nâš ï¸ ×“×•×œ×’×• ${skipped} ×©×•×¨×•×ª/×ª××™× ×œ× ×ª×§×™× ×™×.`;
        if (skipSamples.length) msg += `\n×“×•×’×××•×ª:\n- ${skipSamples.join("\n- ")}`;

        alert(msg);
        ratingsExcelFile.value = "";
      } catch (err) {
        console.error(err);
        alert("×©×’×™××” ×‘×™×™×‘×•× ×“×™×¨×•×’×™×: " + (err.code || err.message || err));
      }
    };

    reader.readAsBinaryString(file);
  };

  function normalizeKey(name, city) {
    const n = String(name || "").trim().toLowerCase().replace(/\s+/g, " ");
    const c = String(city || "").trim().toLowerCase().replace(/\s+/g, " ");
    return `${n}||${c}`;
  }

  function escapeHTML(s){
    return String(s ?? "").replace(/[&<>"']/g, m => ({
      "&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"
    }[m]));
  }
</script>

</body>
</html>
